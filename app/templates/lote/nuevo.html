{% extends "base.html" %}


{% block imports %}


<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>

<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>


<!-- IMPORT DATIMEPICKER -->
<!-- Minified Bootstrap JS -->
<!-- Minified JS library -->
<!-- Minified Bootstrap CSS 
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
-->

<style>
    .cantidadProductoPedido-field {
        font-size: 32px
    }
    .nombreProductoPedido-field {
        font-size: 32px
    }
    .selectPresentacion-field {
        font-size: 40px
    }
    .option-selectPresentacion-field {
        font-size: 30px
    }

    .button-agregarProducto-field {
        font-size: 20px;
        font-weight: bold
    }
</style>


{% endblock %}


{% block title %}
Nuevo Lote
{% endblock %}

{% block content %}
<div id="app">
    <div class="card">
        <div class="card-header">
            <h3 class="box-title">Nuevo Lote</h3>
            <div class="card-header-right">
                <ul class="list-unstyled card-option">
                    <li><i class="fa fa fa-wrench open-card-option"></i></li>
                    <li><i class="fa fa-window-maximize full-card"></i></li>
                    <li><i class="fa fa-minus minimize-card"></i></li>
                    <li><i class="fa fa-refresh reload-card"></i></li>
                    <li><i class="fa fa-trash close-card"></i></li>
                </ul>
            </div>
        </div>
        <div class="card-block table-border-style">
            <div class="table-responsive">
                <div class="white-box">
                    <div class="container col-12">
                        <div class="row">
                            <div class="col-6">
                                <p>Seleccione Almacén</p>
                                <select name="almacen" id="almacen" class="form-control" v-model="almacen_selected">
                                    {% for oAlmacen in oAlmacens %}
                                    <option value="{{ oAlmacen.id }}"> {{ oAlmacen.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <p>Seleccione Provedor</p>
                                <select name="proveedor" id="proveedor" class="form-control" v-model="proveedor_selected">
                                    {% for oProveedor in oProveedors %}
                                    <option value="{{ oProveedor.id }}"> {{ oProveedor.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <hr>

                        <div class="row">
                            <div class="col-6">
                                <label for="id_nombre">Producto:</label>
                                <div class="row">
                                    <div class="col">
                                        <input type="text" ref="inpProducto" v-model="nombreProductoAgregar"  class="form-control nombreProductoPedido-field " 
                                        name="inpt-producto" id="inpt-producto" :disabled="producto_completado">
                                    </div>
                                    
                                    <div class="col" v-show="producto_completado">
                                        <button  type="button" class="btn btn-secondary" @click="changeProductoCompletado">
                                            Editar
                                        </button>
                                    </div>
                                    
                                    <div class="col" v-show="!producto_completado">
                                        <button type="button" class="btn btn-danger " @click="set_nombreProducto('',0)">
                                            Borrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-6">
                                <div class="row">
                                    <div id="selector" class="col">
                                        <label for="id_nombre">Presentación:</label>
                                        <select v-model="selectedPresentacion" class="selectPresentacion-field col-12">
                                            <option class="form-control option-selectPresentacion-field " v-for="(item, key) in lista_presentaciones" :value="key">
                                                [[item]]
                                            </option>
                                        </select>
                                    </div>
                                    
                                    <div class="col">
                                        <label for="id_nombre">Cantidad:</label>
                                        <input v-model="cantProductoAgregar" type="number" min="1" name="cantidad" id="cantidad" required="" class="form-control cantidadProductoPedido-field " >
                                    </div>
                                    <div class="d-flex justify-content-center">
                                        <button class="form-control btn-success" @click="++cantProductoAgregar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="60" fill="currentColor" class="bi bi-plus-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="d-flex justify-content-center">
                                        <button class="form-control btn-danger" @click="--cantProductoAgregar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="60" fill="currentColor" class="bi bi-dash-circle" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                        
                        <hr>

                        <div class="row">
                            <div class="col-6">
                                <div class="row">
                                    <h4>
                                        Productos Encontrados
                                    </h4>
                                </div>
                                <div class="row" style="height: 75 px;">
                                    <div class="col" v-for="(item, index) in arrProductos">
                                            <td>
                                                <button @click="set_nombreProducto(item.id,item.nombre,item.precio)">
                                                    <img :src=[[item.imagen]] class="card-img-top " style="height: 75px; width: 80px;">
                                                    <p>[[item.nombre]]
                                                </button>
                                            </td>
                                        </div>
                                    </tr>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-6"> 
                                <div class="row">
                                    <tr>
                                        {% for oProductoTop in oProductosTop %}
                                            <td>
                                                <button @click="set_nombreProducto('{{oProductoTop.id}}','{{oProductoTop}}',{{ oProductoTop.precio }})">
                                                    <img src="{{ oProductoTop.imagen.url }}" class="card-img-top " alt="{{ oProductoTop.nombre }}" style="height: 75px; height: 80px;">
                                                    <p>{{ oProductoTop.nombre }}</p>
                                                </button>

                                            <td>
                                            {% if forloop.counter|divisibleby:5 %}
                                                {# Start new row #}
                                                </tr>
                                                <tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tr>
                                </div>
                                <meta name="csrf-token" content="{{ csrf_token }}">
                            </div>
                            <div class="row col-6">
                                <div class="col">
                                    <hr>
                                </div>
                                <div class="col">
                                    <p style="font-size: 20px;" v-if="precioProductoAgregar!==0"> PRECIO UNIT.: [[precioProductoAgregar]]</p>
                                    <p style="font-size: 40px;"> TOTAL S/. [[totalProductoAgregar]]</p>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12 ">
                                <button class="btn btn-success col-12 button-agregarProducto-field" @click="agregarProductoPedido"> Agregar Producto</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="box-title">Contenido:</h3>
            <div class="card-header-right">
                <ul class="list-unstyled card-option">
                    <li><i class="fa fa fa-wrench open-card-option"></i></li>
                    <li><i class="fa fa-window-maximize full-card"></i></li>
                    <li><i class="fa fa-minus minimize-card"></i></li>
                    <li><i class="fa fa-refresh reload-card"></i></li>
                    <li><i class="fa fa-trash close-card"></i></li>
                </ul>
            </div>
        </div>
        <div class="card-block table-border-style">
            <div class="table-responsive">
                <div class="white-box">
                    <div class="container col-12">
                        <div class="row">
                            <div class="col-6">
                                <div class="table table-borderless" id="table">
                                    <table class="table table-borderless" id="table">
                                        <thead>
                                            <tr>
                                                <th scope="col">#</th>
                                                <th scope="col">Nombre Producto</th>
                                                <th scope="col">Presentación Producto</th>
                                                <th scope="col">
                                                    <p @click="change_editar_cantidadItems">
                                                        Cantidad Producto 
                                                    </p>
                                                    
                                                    <button v-if="editar_cantidadItems" class="btn btn-success" @click="change_editar_cantidadItems">Guardar</button>
                                                </th>
                                                <th scope="col">
                                                    <p @click="change_editar_precioItems">
                                                        Precio Producto
                                                    </p>    
                                                    <button v-if="editar_precioItems" class="btn btn-success" @click="change_editar_precioItems">Guardar</button>
                                                </th>
                                                <th scope="col">Fecha Vencimiento Producto</th>
                                            </tr>
                                        </thead>
                                        <tr v-for="item in items">
                                            <td>[[item.id]]</td>
                                            <td>[[item.nombre_producto]]</td>
                                            <td>[[item.presentacion_producto]]</td>
                                            <td>
                                                <p v-if="!editar_cantidadItems">
                                                    [[item.cantidad_producto]]
                                                </p>
                                                <input v-if="editar_cantidadItems" type="number" min="0" v-model ="item.cantidad_producto" class="form-control"> 
                                            </td>
                                            <td>
                                                <p v-if="!editar_precioItems">
                                                    [[item.precio_producto]]
                                                </p>
                                                <input v-if="editar_precioItems" type="number" min="0" v-model ="item.precio_producto" class="form-control"> 
                                            </td>
                                            <td>
                                                <input size="16" type="date" v-model="item.fechaVenc_producto" class="form-control" id="datetime" >
                                            </td>

                                        </tr>
                                    </tbody>
                                </table>
                                
                            </div>
                        </div>
                         

                        <div class="col-6">
                            <div class="row">
                                <div class="col">
                                    <h1>Monto Total S/. [[monto_total]]</h1>
                                </div>
                                <div class="col">
                                    <button class="btn btn-success col-12 button-agregarProducto-field" @click="guardar_operacion"> Guardar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer  %}

<script type="text/javascript">
    new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        computed: {
            editableFields() {
            return this.fields.filter(field => field.editable)
            }
        },
        created() {
            window.csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            console.log("created")
            //this.buscar_producto()
            console.log(this.arrProductos)
            //this.buscar_presentaciones_producto()
        },
        data:   {
            fields: [
                { key: "name", label: "Name"},
                { key: "department", label: "Department" },
                { key: "age", label: "Age" },
                { key: "dateOfBirth", label: "Date Of Birth" },
            ],

            done: '',
            producto_completado : false,
            editar_precioItems: false,
            editar_cantidadItems: false,
            lista_presentaciones: {},
             
            items: [
                {id: '13', nombre_producto: 'Molde', presentacion_producto: 'Ca', cantidad_producto: 1, precio_producto: 129, fechaVenc_producto: ''}, {id: '13', nombre_producto: 'Molde', presentacion_producto: 'De(10)', cantidad_producto: 1, precio_producto: 23, fechaVenc_producto: ''}, {id: '13', nombre_producto: 'Molde', presentacion_producto: 'Un', cantidad_producto: 1, precio_producto: 2.4, fechaVenc_producto: ''}
            ],
            selectedPresentacion: '',
            idProductoAgregar : 0,
            nombreProductoAgregar : '',
            nombreProducto: '',
            precioProductoAgregar: 0,
            totalProductoAgregar: 0,
            cantProductoAgregar: 0,
            arrProductos: [],
            arr_productos_sugeridos: [],
            objsPresentaciones: [],
            monto_total: 0,

            almacen_selected: '',
            proveedor_selected: '',
        },
        
        watch: {
            nombreProductoAgregar: function(val){
                this.buscar_producto()
            },
            items: function(val){
                console.log("Lof Func: vuejs_watch_items[]")
            },
            cantProductoAgregar: function(val){
                if (this.precioProductoAgregar != 0 && this.cantProductoAgregar !=0){
                    this.totalProductoAgregar = this.cantProductoAgregar*this.precioProductoAgregar
                    
                } 
            },
            idProductoAgregar: function(val){
                if(this.idProductoAgregar !=0){
                    this.buscar_presentaciones_producto()
                    console.log("LOG FUNC: 'IDPRODUCTOAGREGAR'")
                }
            },
            selectedPresentacion: function(val){
                this.totalProductoAgregar = 0
                this.cantProductoAgregar = 0
                for (let index = 0; index < this.objsPresentaciones.length; index++) {
                    //const element = array[index];
                    if(this.objsPresentaciones[index]['presentacion']['codigo']==val){
                        this.precioProductoAgregar = this.objsPresentaciones[index]['precio_venta']
                    }
                }
            }
        }
        ,
        methods: {
            async buscar_producto(){
                let data = {
                    nombreProducto : this.nombreProductoAgregar,
                };
                if (this.nombreProductoAgregar!=''){
                    axios.post("/producto/buscar/", data).then((result) => {
                        const data = result.data;
                        if (data){
                            //console.log(data['productos'])
                            this.autocompletar(data['productos'])
                        }
                        else{
                            alert("Error")
                        }
                    });
                }else{
                    //alert('Alerta: nombre_producto ')
                    this.nombreProductoAgregar = ''
                    this.arrProductos = []
                }
            },

            async send_datos_operacion(){
                //alert(window.csrfToken)
                let datos = {}
                datos["productos"] = this.items
                datos["almacen"] = this.almacen_selected
                datos["proveedor"] = this.proveedor_selected

                axios.post(".",datos,{headers: {'X-CSRFToken' : window.csrfToken}}).then((result)=> {
                    let data = result.data;
                    console.log (data)
                    //alert("send_datos completado!")
                });
            },

            async buscar_presentaciones_producto(){
                const pk = this.idProductoAgregar
                //const pk = '123'
                if (pk>0){
                    axios.get("/producto/presentacion/listar/?pk="+pk)
                        .then((response) => {
                            const data = response.data;
                            this.lista_clientes = data
                            console.log("log func: listar producto presentacion")
                            console.log(data)
                            console.log(data.length)
                            this.lista_presentaciones = {}
                            let presentaciones = {}
                            for (let index = 0; index < data.length; index++) {
                                console.log("# Log func: buscar presentacion producto  FOR")
                                let codigo = data[index]['presentacion']['codigo']
                                let element = data[index]['presentacion']['nombre'];
    
                                console.log(element)
                                console.log(codigo)
                                presentaciones[codigo] = element
                                console.log("LOG presentaciones")
                                console.log(presentaciones)
                                
                            }
                            this.objsPresentaciones = data
                            this.lista_presentaciones = presentaciones
                        })
                        .catch(function(error){
                    });    
                }
            },

            agregarProductoPedido: function(){
                if (this.nomProductComplete=!''&&this.cantProductoAgregar>0){
                    objProducto = {
                         id: this.idProductoAgregar, nombre_producto: this.nombreProductoAgregar, presentacion_producto:this.selectedPresentacion, cantidad_producto:this.cantProductoAgregar,precio_producto:this.precioProductoAgregar, fechaVenc_producto:''
                         }
                    this.items.push(objProducto)
                    console.log(this.items)
                    this.nombreProductoAgregar = ''
                    this.cantProductoAgregar = 0
                    this.precioProductoAgregar = 0
                    this.totalProductoAgregar = 0
                    this.producto_completado = false
                    this.calcular_total_operacion()
                }
            },
            
            changeProductoCompletado: function(){
                if (this.producto_completado == true){
                    this.producto_completado = false
                }
                else{
                    this.producto_completado = true
                }
            },
            change_editar_cantidadItems: function(){
                console.log(this.editar_cantidadItems)
                if (this.editar_cantidadItems == true){
                    this.editar_cantidadItems = false
                    this.calcular_total_operacion()
                }
                else{
                    this.editar_cantidadItems = true
                }
            },
            change_editar_precioItems: function(){
                console.log(this.editar_precioItems)
                if (this.editar_precioItems == true){
                    this.editar_precioItems = false
                    this.calcular_total_operacion()
                }
                else{
                    this.editar_precioItems = true
                }
            },
            calcular_total_operacion: function(){
                this.monto_total = 0
                for (let index = 0; index < this.items.length; index++) {
                    this.monto_total += this.items[index]['cantidad_producto']*this.items[index]['precio_producto']
                    //const element = array[index];
                }
                this.monto_total = Math.round((this.monto_total)*100)/ 100
            },
            set_nombreProducto: function(idProducto,nombre_producto,precio){
                if (this.producto_completado==false){
                    this.idProductoAgregar = idProducto
                    this.producto_completado = false
                    this.nombreProductoAgregar = nombre_producto
                    this.precioProductoAgregar = precio
                    
                    if (nombre_producto!=''){
                        this.producto_completado = true
                        this.nombreProductoAgregar = nombre_producto
                    }
                    else{
                        this.totalProductoAgregar = 0
                    }
                    this.buscar_presentaciones_producto()
                    this.cantProductoAgregar = 0
                }
            },
            setValueProductoAgregar: function(oProducto){
                $( "#inpt-producto" ).val(oProducto.nombre);
            },
            guardar_operacion: function(){
                console.log("Log Func: guardar_operacion ")
                console.log(this.items)
                this.send_datos_operacion()

            },
            autocompletar: function(data){
                var arr_productos = []
                for (let index = 0; index < data.length; index++) {
                    arr_productos.push(data[index].nombre);
                }
                this.arrProductos = data
                
                console.log(arr_productos)
                console.log(this.arrProductos)

            },
        },
    });
</script>


{% endblock %}


